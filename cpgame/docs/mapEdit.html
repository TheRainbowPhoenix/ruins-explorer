<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilemap Editor</title>
    <style>
        :root {
            /* Modern Dark Color Scheme */
            --bg-primary: hsl(240, 20%, 4%);
            --bg-secondary: hsl(240, 20%, 8%);
            --bg-tertiary: hsl(240, 20%, 10%);
            --bg-elevated: hsl(240, 25%, 12%);
            --bg-surface: hsl(240, 10%, 15%);
            
            --border-primary: hsl(240, 25%, 16%);
            --border-secondary: hsl(240, 25%, 20%);
            --border-tertiary: hsl(240, 25%, 25%);
            
            --text-primary: #ffffff;
            --text-secondary: hsl(240, 25%, 70%);
            --text-muted: hsl(240, 10%, 45%);
            --text-disabled: #525252;
            
            /* More refined accent colors */
            --accent-primary: hsl(240, 81%, 60%);
            --accent-primary-hover: hsl(240, 73%, 53%);
            --accent-primary-active: hsl(245, 66%, 48%);
            --accent-secondary: hsl(255, 84%, 67%);
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-info: #06b6d4;
            
            /* Subtle accent variations */
            --accent-primary-subtle: rgba(59, 130, 246, 0.1);
            --accent-primary-muted: rgba(59, 130, 246, 0.2);
            
            /* Layout */
            --activity-bar-width: 48px;
            --sidebar-width: 280px;
            --panel-padding: 20px;
            --border-radius-sm: 4px;
            --border-radius: 6px;
            --border-radius-lg: 8px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }
        
        /* Main Layout */
        .workbench {
            display: flex;
            height: 100vh;
        }
        
        /* Activity Bar */
        .activity-bar {
            width: var(--activity-bar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            gap: 8px;
        }
        
        .activity-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
            position: relative;
        }
        
        .activity-item:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .activity-item.active {
            color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.1);
        }
        
        .activity-item.active::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 16px;
            background: var(--accent-primary);
        }

        .activity-separator {
            height: 2px;
            padding: 0px 8px;
            border-bottom: 2px solid var(--text-muted);
        }

        .activity-logo-header {
            width: 32px;
            height: 32px;   
        }

        .activity-logo {
            width: 32px;
            height: 32px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            filter: grayscale(0.4);
        }

        .activity-logo:hover {
            opacity: 1;
            filter: grayscale(0);
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        
        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }
        
        .sidebar-header {
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            cursor: default;
            font-weight: 400;
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            background: var(--bg-secondary);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Canvas Container */
        .canvas-container {
            flex: 1;
            overflow: auto;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tilemap-canvas {
            background: var(--bg-surface);
            box-shadow: var(--shadow-lg);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* Panels */
        .panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-content {
            padding: 16px;
        }
        
        .panel-title {
            margin: 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }

        /* Form Elements */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .form-label {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: var(--font-size-small);
            font-family: var(--font-mono);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: var(--font-mono);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:focus-visible {
            box-shadow: 0 0 0 2px var(--accent-primary-subtle), 0 0 0 4px var(--accent-primary);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-surface);
            border-color: var(--border-tertiary);
        }
        
        .btn-danger {
            background: var(--accent-error);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Tile Palette */
        .tile-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tile-item {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .tile-item:hover {
            border-color: var(--accent-primary);
        }

        .tile-item.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        /* Event List */
        .event-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
        }

        .event-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .event-item:hover {
            background: var(--bg-tertiary);
        }

        .event-item.active {
            background: var(--accent-primary-subtle);
            border-left: 3px solid var(--accent-primary);
        }

        .event-item:last-child {
            border-bottom: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            background: hsla(240, 20%, 0%, 0.8);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            transition: var(--transition);
        }
        
        .zoom-btn:hover {
            background: rgba(0, 212, 255, 0.8);
            border-color: var(--accent-primary);
        }

        /* Status Bar */
        .status-bar {
            height: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .status-item {
            margin-right: 16px;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .mode-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Dialog */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .dialog-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .dialog-footer {
            padding: 16px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Page Editor */
        .page-editor {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graphic-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .graphic-item {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .graphic-item.selected {
            border-color: var(--accent-primary);
        }

        .payload-editor {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payload-type-selector {
            display: flex;
            gap: 8px;
        }

        .payload-type-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .payload-type-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .dialog-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dialog-message {
            display: flex;
            gap: 8px;
        }

        .dialog-message input {
            flex: 1;
        }

        .action-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }
    </style>
</head>
<body>
    <div class="workbench">
        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-logo-header" title="Tilemap Editor">
                <svg class="activity-logo" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="24" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                    <rect x="8" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="8" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="8" y="20" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="20" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="20" width="4" height="4" fill="currentColor"/>
                </svg>
            </div>
            <div class="activity-separator"></div>
            <div class="activity-item active" data-panel="tiles" title="Tiles">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
            </div>
            <div class="activity-item" data-panel="events" title="Events">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <div class="activity-item" data-panel="export" title="Export">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span id="sidebar-title">Tiles</span>
            </div>
            <div class="sidebar-content" id="sidebar-content">
                <!-- Content will be injected based on state -->
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="tilemap-canvas" width="640" height="400"></canvas>
            </div>
            <div class="status-bar">
                <div class="status-item">Position: <span id="cursor-position">0, 0</span></div>
                <div class="status-item">Zoom: <span id="zoom-level">1x</span></div>
                <div class="status-item">Mode: <span id="editor-mode">Tile</span></div>
            </div>
        </div>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-in">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button class="zoom-btn" id="zoom-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button class="zoom-btn" id="zoom-reset">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <polyline points="23 20 23 14 17 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Panel Templates -->
    <template id="panel-tiles">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Tile Palette</h3>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label">Drawing Mode</label>
                    <div class="mode-selector">
                        <div class="mode-btn active" data-mode="place">Place</div>
                        <div class="mode-btn" data-mode="brush">Brush</div>
                        <div class="mode-btn" data-mode="area">Area</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Tile</label>
                    <div id="selected-tile-preview" style="width: 64px; height: 64px; border: 2px solid var(--border-primary); background: var(--bg-tertiary); image-rendering: pixelated;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tiles</label>
                    <div class="tile-palette" id="tile-palette"></div>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="fill-map">Fill Map</button>
                </div>
            </div>
        </div>
    </template>

    <template id="panel-events">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Events</h3>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label">Event List</label>
                    <div class="event-list" id="event-list"></div>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="add-event">Add Event</button>
                    <button class="btn btn-secondary" id="edit-event" disabled>Edit Event</button>
                    <button class="btn btn-danger" id="remove-event" disabled>Remove Event</button>
                </div>
            </div>
        </div>
    </template>

    <template id="panel-export">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Export Data</h3>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label class="form-label">Map Data</label>
                    <textarea class="form-textarea" id="export-map-data" readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Events Data</label>
                    <textarea class="form-textarea" id="export-events-data" readonly></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="copy-map-data">Copy Map Data</button>
                    <button class="btn btn-primary" id="copy-events-data">Copy Events Data</button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Editor state
        const state = {
            currentPanel: 'tiles',
            currentTool: 'place',
            selectedTile: 0,
            zoomLevel: 1,
            mapWidth: 32,
            mapHeight: 20,
            tileSize: 20,
            // Initialize map with all 0s
            mapData: Array(32 * 20).fill(0),
            events: {},
            selectedEvent: null,
            selectedPosition: { x: 0, y: 0 },
            isDrawing: false,
            areaStart: null,
            areaEnd: null
        };

        // Canvas and context
        const canvas = document.getElementById('tilemap-canvas');
        const ctx = canvas.getContext('2d');

        // Tileset image
        const tileset = new Image();
        tileset.src = 'tileset.png';

        // Wait for tileset to load
        tileset.onload = () => {
            renderMap();
            updateTilePalette();
            updateEventList();
            updateExportData();
        };

        // Activity bar navigation
        document.querySelectorAll('.activity-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.activity-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                state.currentPanel = item.dataset.panel;
                updateSidebar();
            });
        });

        // Mode selector
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-btn')) {
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                state.currentTool = e.target.dataset.mode;
                document.getElementById('editor-mode').textContent = 
                    state.currentTool.charAt(0).toUpperCase() + state.currentTool.slice(1);
            }
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            if (state.zoomLevel < 4) {
                state.zoomLevel *= 2;
                updateZoom();
            }
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            if (state.zoomLevel > 1) {
                state.zoomLevel /= 2;
                updateZoom();
            }
        });

        document.getElementById('zoom-reset').addEventListener('click', () => {
            state.zoomLevel = 1;
            updateZoom();
        });

        // Canvas interaction
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (state.tileSize * state.zoomLevel));
            const y = Math.floor((e.clientY - rect.top) / (state.tileSize * state.zoomLevel));
            
            if (x >= 0 && x < state.mapWidth && y >= 0 && y < state.mapHeight) {
                state.selectedPosition = { x, y };
                document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                
                if (state.currentPanel === 'tiles') {
                    state.isDrawing = true;
                    if (state.currentTool === 'place') {
                        placeTile(x, y);
                    } else if (state.currentTool === 'area') {
                        state.areaStart = { x, y };
                        state.areaEnd = { x, y };
                    }
                } else if (state.currentPanel === 'events') {
                    // Handle event placement/editing
                    const posKey = `${x},${y}`;
                    if (state.events[posKey]) {
                        // Edit existing event
                        state.selectedEvent = state.events[posKey];
                        document.getElementById('edit-event').disabled = false;
                        document.getElementById('remove-event').disabled = false;
                    } else {
                        // Add new event
                        state.selectedEvent = {
                            id: Object.keys(state.events).length + 1,
                            name: `Event ${Object.keys(state.events).length + 1}`,
                            pages: [{
                                graphic: { tile_id: 0 },
                                payload: ["New message..."]
                            }]
                        };
                        document.getElementById('edit-event').disabled = false;
                        document.getElementById('remove-event').disabled = false;
                    }
                    updateEventList();
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!state.isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (state.tileSize * state.zoomLevel));
            const y = Math.floor((e.clientY - rect.top) / (state.tileSize * state.zoomLevel));
            
            if (x >= 0 && x < state.mapWidth && y >= 0 && y < state.mapHeight) {
                if (state.currentPanel === 'tiles') {
                    if (state.currentTool === 'brush') {
                        placeTile(x, y);
                    } else if (state.currentTool === 'area') {
                        state.areaEnd = { x, y };
                        renderMap();
                    }
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (state.isDrawing && state.currentTool === 'area' && state.areaStart) {
                // Fill the area
                const startX = Math.min(state.areaStart.x, state.areaEnd.x);
                const endX = Math.max(state.areaStart.x, state.areaEnd.x);
                const startY = Math.min(state.areaStart.y, state.areaEnd.y);
                const endY = Math.max(state.areaStart.y, state.areaEnd.y);
                
                for (let y = startY; y <= endY; y++) {
                    for (let x = startX; x <= endX; x++) {
                        const index = y * state.mapWidth + x;
                        state.mapData[index] = state.selectedTile;
                    }
                }
                
                state.areaStart = null;
                state.areaEnd = null;
                renderMap();
                updateExportData();
            }
            
            state.isDrawing = false;
        });

        // Tile placement function
        function placeTile(x, y) {
            const index = y * state.mapWidth + x;
            state.mapData[index] = state.selectedTile;
            renderMap();
            updateExportData();
        }

        // Sidebar buttons
        document.addEventListener('click', (e) => {
            if (e.target.id === 'fill-map') {
                state.mapData = Array(state.mapWidth * state.mapHeight).fill(state.selectedTile);
                renderMap();
                updateExportData();
            }
            
            if (e.target.id === 'add-event') {
                // Add event at selected position
                const posKey = `${state.selectedPosition.x},${state.selectedPosition.y}`;
                if (!state.events[posKey]) {
                    state.events[posKey] = {
                        id: Object.keys(state.events).length + 1,
                        name: `Event ${Object.keys(state.events).length + 1}`,
                        pages: [{
                            graphic: { tile_id: 0 },
                            payload: ["New message..."]
                        }]
                    };
                    updateEventList();
                    updateExportData();
                }
            }
            
            if (e.target.id === 'edit-event') {
                if (state.selectedEvent) {
                    showEventEditorDialog();
                }
            }
            
            if (e.target.id === 'remove-event') {
                const posKey = `${state.selectedPosition.x},${state.selectedPosition.y}`;
                if (state.events[posKey]) {
                    delete state.events[posKey];
                    state.selectedEvent = null;
                    updateEventList();
                    updateExportData();
                    document.getElementById('edit-event').disabled = true;
                    document.getElementById('remove-event').disabled = true;
                }
            }
        });

        // Export functionality
        document.addEventListener('click', (e) => {
            if (e.target.id === 'copy-map-data') {
                navigator.clipboard.writeText(document.getElementById('export-map-data').value);
            }
            
            if (e.target.id === 'copy-events-data') {
                navigator.clipboard.writeText(document.getElementById('export-events-data').value);
            }
        });

        // Initialize
        updateSidebar();
        updateZoom();

        // Functions
        function updateSidebar() {
            const sidebarContent = document.getElementById('sidebar-content');
            const panelTemplate = document.getElementById(`panel-${state.currentPanel}`);
            
            if (panelTemplate) {
                const panelTitles = {
                    'tiles': 'Tiles',
                    'events': 'Events',
                    'export': 'Export'
                };
                
                document.getElementById('sidebar-title').textContent = panelTitles[state.currentPanel];
                sidebarContent.innerHTML = '';
                sidebarContent.appendChild(panelTemplate.content.cloneNode(true));
                
                // Update panel-specific content
                if (state.currentPanel === 'tiles') {
                    updateTilePalette();
                    updateSelectedTilePreview();
                    // Set active mode button
                    document.querySelectorAll('.mode-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === state.currentTool);
                    });
                } else if (state.currentPanel === 'events') {
                    updateEventList();
                } else if (state.currentPanel === 'export') {
                    updateExportData();
                }
            }
        }

        function updateZoom() {
            const newWidth = state.mapWidth * state.tileSize * state.zoomLevel;
            const newHeight = state.mapHeight * state.tileSize * state.zoomLevel;
            canvas.width = newWidth;
            canvas.height = newHeight;
            document.getElementById('zoom-level').textContent = `${state.zoomLevel}x`;
            renderMap();
        }

        function renderMap() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw map tiles
            for (let y = 0; y < state.mapHeight; y++) {
                for (let x = 0; x < state.mapWidth; x++) {
                    const tileId = state.mapData[y * state.mapWidth + x];
                    drawTile(x, y, tileId);
                }
            }
            
            // Draw events
            Object.keys(state.events).forEach(posKey => {
                const [x, y] = posKey.split(',').map(Number);
                const event = state.events[posKey];
                drawEvent(x, y, event.pages[0].graphic.tile_id);
            });
            
            // Draw area selection
            if (state.areaStart && state.areaEnd) {
                const startX = Math.min(state.areaStart.x, state.areaEnd.x);
                const endX = Math.max(state.areaStart.x, state.areaEnd.x);
                const startY = Math.min(state.areaStart.y, state.areaEnd.y);
                const endY = Math.max(state.areaStart.y, state.areaEnd.y);
                
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    startX * state.tileSize * state.zoomLevel,
                    startY * state.tileSize * state.zoomLevel,
                    (endX - startX + 1) * state.tileSize * state.zoomLevel,
                    (endY - startY + 1) * state.tileSize * state.zoomLevel
                );
            }
            
            // Highlight selected position
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                state.selectedPosition.x * state.tileSize * state.zoomLevel,
                state.selectedPosition.y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel
            );
        }

        function drawTile(x, y, tileId) {
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (tileId % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(tileId / tilesPerRow) * state.tileSize;
            
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                x * state.tileSize * state.zoomLevel, y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel, state.tileSize * state.zoomLevel
            );
        }

        function drawEvent(x, y, tileId) {
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (tileId % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(tileId / tilesPerRow) * state.tileSize;
            
            ctx.save();
            ctx.globalAlpha = 0.7;
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                x * state.tileSize * state.zoomLevel, y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel, state.tileSize * state.zoomLevel
            );
            ctx.restore();
        }

        function updateTilePalette() {
            const palette = document.getElementById('tile-palette');
            if (!palette) return;
            
            palette.innerHTML = '';
            
            // Create 160 tiles (8x20 grid)
            for (let i = 0; i < 160; i++) {
                const tileItem = document.createElement('div');
                tileItem.className = 'tile-item';
                tileItem.dataset.tileId = i;
                
                // Create canvas for tile preview
                const tileCanvas = document.createElement('canvas');
                tileCanvas.width = 20;
                tileCanvas.height = 20;
                const tileCtx = tileCanvas.getContext('2d');
                
                const tilesPerRow = Math.floor(tileset.width / state.tileSize);
                const srcX = (i % tilesPerRow) * state.tileSize;
                const srcY = Math.floor(i / tilesPerRow) * state.tileSize;
                
                tileCtx.imageSmoothingEnabled = false;
                tileCtx.drawImage(
                    tileset,
                    srcX, srcY, state.tileSize, state.tileSize,
                    0, 0, 20, 20
                );
                
                tileItem.appendChild(tileCanvas);
                
                if (i === state.selectedTile) {
                    tileItem.classList.add('selected');
                }
                
                tileItem.addEventListener('click', () => {
                    state.selectedTile = i;
                    document.querySelectorAll('.tile-item').forEach(item => item.classList.remove('selected'));
                    tileItem.classList.add('selected');
                    updateSelectedTilePreview();
                });
                
                palette.appendChild(tileItem);
            }
        }

        function updateSelectedTilePreview() {
            const preview = document.getElementById('selected-tile-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            const tileCanvas = document.createElement('canvas');
            tileCanvas.width = 64;
            tileCanvas.height = 64;
            const tileCtx = tileCanvas.getContext('2d');
            
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (state.selectedTile % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(state.selectedTile / tilesPerRow) * state.tileSize;
            
            tileCtx.imageSmoothingEnabled = false;
            tileCtx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                0, 0, 64, 64
            );
            
            preview.appendChild(tileCanvas);
        }

        function updateEventList() {
            const eventList = document.getElementById('event-list');
            if (!eventList) return;
            
            eventList.innerHTML = '';
            
            Object.keys(state.events).forEach(posKey => {
                const [x, y] = posKey.split(',').map(Number);
                const event = state.events[posKey];
                
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                if (x === state.selectedPosition.x && y === state.selectedPosition.y) {
                    eventItem.classList.add('active');
                }
                
                eventItem.innerHTML = `
                    <div><strong>${event.name}</strong></div>
                    <div>Position: ${x}, ${y}</div>
                `;
                
                eventItem.addEventListener('click', () => {
                    state.selectedPosition = { x, y };
                    state.selectedEvent = event;
                    document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                    document.querySelectorAll('.event-item').forEach(item => item.classList.remove('active'));
                    eventItem.classList.add('active');
                    document.getElementById('edit-event').disabled = false;
                    document.getElementById('remove-event').disabled = false;
                    renderMap();
                });
                
                eventList.appendChild(eventItem);
            });
        }

        function showEventEditorDialog() {
            // Create dialog overlay
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            
            // Create dialog
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            
            // Dialog header
            const header = document.createElement('div');
            header.className = 'dialog-header';
            header.innerHTML = `
                <h3>Edit Event</h3>
                <button class="btn btn-secondary" id="close-dialog">âœ•</button>
            `;
            
            // Dialog content
            const content = document.createElement('div');
            content.className = 'dialog-content';
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" class="form-input" id="event-name" value="${state.selectedEvent.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Page</label>
                    <select class="form-select" id="page-selector">
                        ${state.selectedEvent.pages.map((page, index) => 
                            `<option value="${index}">Page ${index + 1}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="page-editor" id="page-editor">
                    <!-- Page editor content will be inserted here -->
                </div>
            `;
            
            // Dialog footer
            const footer = document.createElement('div');
            footer.className = 'dialog-footer';
            footer.innerHTML = `
                <button class="btn btn-secondary" id="add-page">Add Page</button>
                <button class="btn btn-danger" id="delete-page">Delete Page</button>
                <button class="btn btn-primary" id="save-event-dialog">Save</button>
            `;
            
            dialog.appendChild(header);
            dialog.appendChild(content);
            dialog.appendChild(footer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Initialize page editor
            updatePageEditor(0);
            
            // Event listeners
            document.getElementById('close-dialog').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            document.getElementById('page-selector').addEventListener('change', (e) => {
                updatePageEditor(parseInt(e.target.value));
            });
            
            document.getElementById('add-page').addEventListener('click', () => {
                state.selectedEvent.pages.push({
                    graphic: { tile_id: 0 },
                    payload: ["New message..."]
                });
                const selector = document.getElementById('page-selector');
                const newIndex = state.selectedEvent.pages.length - 1;
                const option = document.createElement('option');
                option.value = newIndex;
                option.textContent = `Page ${newIndex + 1}`;
                selector.appendChild(option);
                selector.value = newIndex;
                updatePageEditor(newIndex);
            });
            
            document.getElementById('delete-page').addEventListener('click', () => {
                const selector = document.getElementById('page-selector');
                const index = parseInt(selector.value);
                if (state.selectedEvent.pages.length > 1) {
                    state.selectedEvent.pages.splice(index, 1);
                    selector.innerHTML = state.selectedEvent.pages.map((page, i) => 
                        `<option value="${i}">Page ${i + 1}</option>`
                    ).join('');
                    selector.value = Math.max(0, index - 1);
                    updatePageEditor(parseInt(selector.value));
                }
            });
            
            document.getElementById('save-event-dialog').addEventListener('click', () => {
                // Save current page
                saveCurrentPage();
                
                // Update event data
                state.selectedEvent.name = document.getElementById('event-name').value;
                
                // Save to events object
                const posKey = `${state.selectedPosition.x},${state.selectedPosition.y}`;
                state.events[posKey] = state.selectedEvent;
                
                // Update UI
                updateEventList();
                updateExportData();
                renderMap();
                
                // Close dialog
                document.body.removeChild(overlay);
            });
        }

        function updatePageEditor(pageIndex) {
            const page = state.selectedEvent.pages[pageIndex];
            const editor = document.getElementById('page-editor');
            
            editor.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Graphic</label>
                    <div class="graphic-picker" id="graphic-picker">
                        <!-- Graphic tiles will be inserted here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Payload Type</label>
                    <div class="payload-type-selector">
                        <div class="payload-type-btn ${Array.isArray(page.payload) ? 'active' : ''}" data-type="dialog">Dialog</div>
                        <div class="payload-type-btn ${!Array.isArray(page.payload) ? 'active' : ''}" data-type="action">Action</div>
                    </div>
                </div>
                <div class="payload-editor" id="payload-editor">
                    <!-- Payload editor will be inserted here -->
                </div>
            `;
            
            // Populate graphic picker
            const graphicPicker = document.getElementById('graphic-picker');
            for (let i = 0; i < 160; i++) {
                const graphicItem = document.createElement('div');
                graphicItem.className = 'graphic-item';
                graphicItem.dataset.tileId = i;
                
                const tileCanvas = document.createElement('canvas');
                tileCanvas.width = 20;
                tileCanvas.height = 20;
                const tileCtx = tileCanvas.getContext('2d');
                
                const tilesPerRow = Math.floor(tileset.width / state.tileSize);
                const srcX = (i % tilesPerRow) * state.tileSize;
                const srcY = Math.floor(i / tilesPerRow) * state.tileSize;
                
                tileCtx.imageSmoothingEnabled = false;
                tileCtx.drawImage(
                    tileset,
                    srcX, srcY, state.tileSize, state.tileSize,
                    0, 0, 20, 20
                );
                
                graphicItem.appendChild(tileCanvas);
                
                if (i === page.graphic.tile_id) {
                    graphicItem.classList.add('selected');
                }
                
                graphicItem.addEventListener('click', () => {
                    document.querySelectorAll('.graphic-item').forEach(item => item.classList.remove('selected'));
                    graphicItem.classList.add('selected');
                    page.graphic.tile_id = i;
                });
                
                graphicPicker.appendChild(graphicItem);
            }
            
            // Set up payload type buttons
            document.querySelectorAll('.payload-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.payload-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updatePayloadEditor(pageIndex, btn.dataset.type);
                });
            });
            
            // Initialize payload editor
            const payloadType = Array.isArray(page.payload) ? 'dialog' : 'action';
            updatePayloadEditor(pageIndex, payloadType);
        }

        function updatePayloadEditor(pageIndex, type) {
            const page = state.selectedEvent.pages[pageIndex];
            const editor = document.getElementById('payload-editor');
            
            if (type === 'dialog') {
                // Convert to dialog if needed
                if (!Array.isArray(page.payload)) {
                    page.payload = ["New message..."];
                }
                
                let messagesHtml = '';
                page.payload.forEach((msg, index) => {
                    messagesHtml += `
                        <div class="dialog-message">
                            <input type="text" class="form-input dialog-message-input" data-index="${index}" value="${msg}">
                            <button class="btn btn-danger remove-message" data-index="${index}">âœ•</button>
                        </div>
                    `;
                });
                
                editor.innerHTML = `
                    <div class="dialog-messages">
                        ${messagesHtml}
                        <button class="btn btn-secondary" id="add-message">Add Message</button>
                    </div>
                `;
                
                // Add message button
                document.getElementById('add-message').addEventListener('click', () => {
                    page.payload.push("New message...");
                    updatePayloadEditor(pageIndex, 'dialog');
                });
                
                // Remove message buttons
                document.querySelectorAll('.remove-message').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        page.payload.splice(index, 1);
                        updatePayloadEditor(pageIndex, 'dialog');
                    });
                });
                
                // Message input handlers
                document.querySelectorAll('.dialog-message-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        page.payload[index] = e.target.value;
                    });
                });
            } else {
                // Convert to action if needed
                if (Array.isArray(page.payload)) {
                    page.payload = { type: "actor", id: 1 };
                }
                
                const actionType = page.payload.type || "actor";
                
                editor.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Action Type</label>
                        <select class="form-select" id="action-type">
                            <option value="actor" ${actionType === 'actor' ? 'selected' : ''}>Actor</option>
                            <option value="transfer" ${actionType === 'transfer' ? 'selected' : ''}>Transfer</option>
                        </select>
                    </div>
                    <div class="action-fields" id="action-fields">
                        <!-- Action fields will be inserted here -->
                    </div>
                `;
                
                updateActionFields(pageIndex);
                
                document.getElementById('action-type').addEventListener('change', () => {
                    updateActionFields(pageIndex);
                });
            }
        }

        function updateActionFields(pageIndex) {
            const page = state.selectedEvent.pages[pageIndex];
            const actionType = document.getElementById('action-type').value;
            const fields = document.getElementById('action-fields');
            
            if (actionType === 'actor') {
                page.payload = { type: "actor", id: page.payload.id || 1 };
                fields.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Actor ID</label>
                        <input type="number" class="form-input" id="actor-id" min="1" value="${page.payload.id}">
                    </div>
                `;
            } else {
                page.payload = { 
                    type: "transfer", 
                    map_id: page.payload.map_id || 1,
                    x: page.payload.x || 0,
                    y: page.payload.y || 0
                };
                fields.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Map ID</label>
                        <input type="number" class="form-input" id="map-id" min="1" value="${page.payload.map_id}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">X Position</label>
                        <input type="number" class="form-input" id="x-pos" value="${page.payload.x}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Y Position</label>
                        <input type="number" class="form-input" id="y-pos" value="${page.payload.y}">
                    </div>
                `;
            }
        }

        function saveCurrentPage() {
            const pageIndex = parseInt(document.getElementById('page-selector').value);
            const page = state.selectedEvent.pages[pageIndex];
            
            // Save graphic
            const selectedGraphic = document.querySelector('.graphic-item.selected');
            if (selectedGraphic) {
                page.graphic.tile_id = parseInt(selectedGraphic.dataset.tileId);
            }
            
            // Save payload
            const payloadType = document.querySelector('.payload-type-btn.active').dataset.type;
            if (payloadType === 'dialog') {
                // Dialog messages are already saved in real-time
            } else {
                // Save action fields
                const actionType = document.getElementById('action-type').value;
                if (actionType === 'actor') {
                    page.payload = {
                        type: "actor",
                        id: parseInt(document.getElementById('actor-id').value)
                    };
                } else {
                    page.payload = {
                        type: "transfer",
                        map_id: parseInt(document.getElementById('map-id').value),
                        x: parseInt(document.getElementById('x-pos').value),
                        y: parseInt(document.getElementById('y-pos').value)
                    };
                }
            }
        }

        function updateExportData() {
            const mapDataElement = document.getElementById('export-map-data');
            const eventsDataElement = document.getElementById('export-events-data');
            
            if (mapDataElement) {
                let mapDataStr = 'data = [\n';
                for (let i = 0; i < state.mapData.length; i++) {
                    if (i % state.mapWidth === 0 && i > 0) {
                        mapDataStr += ',\n';
                    }
                    mapDataStr += `    ${state.mapData[i]}`;
                    if (i < state.mapData.length - 1 && (i + 1) % state.mapWidth !== 0) {
                        mapDataStr += ',';
                    }
                }
                mapDataStr += '\n]';
                mapDataElement.value = mapDataStr;
            }
            
            if (eventsDataElement) {
                let eventsDataStr = 'events = {\n';
                const eventKeys = Object.keys(state.events);
                eventKeys.forEach((posKey, index) => {
                    const [x, y] = posKey.split(',').map(Number);
                    const event = state.events[posKey];
                    eventsDataStr += `    # Event at (x=${x}, y=${y})\n`;
                    eventsDataStr += `    (${x}, ${y}): {\n`;
                    eventsDataStr += `        "id": ${event.id}, "name": "${event.name}",\n`;
                    eventsDataStr += `        "pages": [${JSON.stringify(event.pages[0])}]\n`;
                    eventsDataStr += '    }';
                    if (index < eventKeys.length - 1) {
                        eventsDataStr += ',\n';
                    }
                    eventsDataStr += '\n';
                });
                eventsDataStr += '}';
                eventsDataElement.value = eventsDataStr;
            }
        }
    </script>
</body>
</html>