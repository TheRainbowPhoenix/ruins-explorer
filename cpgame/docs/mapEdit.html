<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilemap Editor</title>
    <style>
        :root {
            /* Modern Dark Color Scheme */
            --bg-primary: hsl(240, 20%, 4%);
            --bg-secondary: hsl(240, 20%, 8%);
            --bg-tertiary: hsl(240, 20%, 10%);
            --bg-elevated: hsl(240, 25%, 12%);
            --bg-surface: hsl(240, 10%, 15%);
            
            --border-primary: hsl(240, 25%, 16%);
            --border-secondary: hsl(240, 25%, 20%);
            --border-tertiary: hsl(240, 25%, 25%);
            
            --text-primary: #ffffff;
            --text-secondary: hsl(240, 25%, 70%);
            --text-muted: hsl(240, 10%, 45%);
            --text-disabled: #525252;
            
            /* More refined accent colors */
            --accent-primary: hsl(240, 81%, 60%);
            --accent-primary-hover: hsl(240, 73%, 53%);
            --accent-primary-active: hsl(245, 66%, 48%);
            --accent-secondary: hsl(255, 84%, 67%);
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-info: #06b6d4;
            
            /* Subtle accent variations */
            --accent-primary-subtle: rgba(59, 130, 246, 0.1);
            --accent-primary-muted: rgba(59, 130, 246, 0.2);
            
            /* Layout */
            --activity-bar-width: 48px;
            --sidebar-width: 280px;
            --panel-padding: 20px;
            --border-radius-sm: 4px;
            --border-radius: 6px;
            --border-radius-lg: 8px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }
        
        /* Main Layout */
        .workbench {
            display: flex;
            height: 100vh;
        }
        
        /* Activity Bar */
        .activity-bar {
            width: var(--activity-bar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            gap: 8px;
        }
        
        .activity-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-muted);
            transition: var(--transition);
            position: relative;
        }
        
        .activity-item:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .activity-item.active {
            color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.1);
        }
        
        .activity-item.active::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 16px;
            background: var(--accent-primary);
        }

        .activity-separator {
            height: 2px;
            padding: 0px 8px;
            border-bottom: 2px solid var(--text-muted);
        }

        .activity-logo-header {
            width: 32px;
            height: 32px;   
        }

        .activity-logo {
            width: 32px;
            height: 32px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
            filter: grayscale(0.4);
        }

        .activity-logo:hover {
            opacity: 1;
            filter: grayscale(0);
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        
        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }
        
        .sidebar-header {
            height: 35px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            cursor: default;
            font-weight: 400;
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            background: var(--bg-secondary);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Canvas Container */
        .canvas-container {
            flex: 1;
            overflow: auto;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tilemap-canvas {
            background: var(--bg-surface);
            box-shadow: var(--shadow-lg);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* Panels */
        .panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-content {
            padding: 16px;
        }
        
        .panel-title {
            margin: 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }

        /* Form Elements */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .form-label {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: var(--font-size-small);
            font-family: var(--font-mono);
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: var(--font-mono);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            outline: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:focus-visible {
            box-shadow: 0 0 0 2px var(--accent-primary-subtle), 0 0 0 4px var(--accent-primary);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-surface);
            border-color: var(--border-tertiary);
        }
        
        .btn-danger {
            background: var(--accent-error);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Tile Palette */
        .tile-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
        }

        .tile-item {
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            background-size: 320px 200px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .tile-item:hover {
            border-color: var(--accent-primary);
        }

        .tile-item.selected {
            border-color: var(--accent-primary);
        }

        /* Event List */
        .event-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
        }

        .event-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .event-item:hover {
            background: var(--bg-tertiary);
        }

        .event-item.active {
            background: var(--accent-primary-subtle);
            border-left: 3px solid var(--accent-primary);
        }

        .event-item:last-child {
            border-bottom: none;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            background: hsla(240, 20%, 0%, 0.8);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            transition: var(--transition);
        }
        
        .zoom-btn:hover {
            background: rgba(0, 212, 255, 0.8);
            border-color: var(--accent-primary);
        }

        /* Status Bar */
        .status-bar {
            height: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }

        .status-item {
            margin-right: 16px;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .mode-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Dialog */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .dialog-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .dialog-footer {
            padding: 16px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Page Editor */
        .page-editor {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graphic-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
        }

        .graphic-item {
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            background-size: 320px 200px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .graphic-item.selected {
            border-color: var(--accent-primary);
        }

        .payload-editor {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payload-type-selector {
            display: flex;
            gap: 8px;
        }

        .payload-type-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .payload-type-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .dialog-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dialog-message {
            display: flex;
            gap: 8px;
        }

        .dialog-message input {
            flex: 1;
        }

        .action-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Event Indicator */
        .event-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        /* Command List */
        .command-list {
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
        }

        .command-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .command-item:hover {
            background: var(--bg-tertiary);
        }

        .command-item:last-child {
            border-bottom: none;
        }

        .add-command {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-primary);
            cursor: pointer;
            text-align: center;
            font-weight: var(--font-weight-medium);
        }

        .add-command:hover {
            background: var(--accent-primary-subtle);
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-secondary);
        }
    </style>
</head>
<body>
    <div class="workbench">
        <!-- Activity Bar -->
        <div class="activity-bar">
            <div class="activity-logo-header" title="Tilemap Editor">
                <svg class="activity-logo" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="24" height="24" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                    <rect x="8" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="8" width="4" height="4" fill="currentColor"/>
                    <rect x="8" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="14" width="4" height="4" fill="currentColor"/>
                    <rect x="8" y="20" width="4" height="4" fill="currentColor"/>
                    <rect x="14" y="20" width="4" height="4" fill="currentColor"/>
                    <rect x="20" y="20" width="4" height="4" fill="currentColor"/>
                </svg>
            </div>
            <div class="activity-separator"></div>
            <div class="activity-item active" data-panel="map" title="Map Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
            </div>
            <div class="activity-item" data-panel="tiles" title="Tiles">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
            </div>
            <div class="activity-item" data-panel="events" title="Events">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <div class="activity-item" data-panel="export" title="Export">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span id="sidebar-title">Map Settings</span>
            </div>
            <div class="sidebar-content" id="sidebar-content">
                <!-- Content will be injected based on state -->
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="tilemap-canvas" width="640" height="400"></canvas>
            </div>
            <div class="status-bar">
                <div class="status-item">Position: <span id="cursor-position">0, 0</span></div>
                <div class="status-item">Zoom: <span id="zoom-level">1x</span></div>
                <div class="status-item">Mode: <span id="editor-mode">Tile</span></div>
            </div>
        </div>
        
        <!-- Zoom Controls -->
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-in">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button class="zoom-btn" id="zoom-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
            <button class="zoom-btn" id="zoom-reset">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <polyline points="23 20 23 14 17 14"></polyline>
                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Panel Templates -->
    <template id="panel-map">
        <div class="form-group">
            <label class="form-label">Display Name</label>
            <input type="text" class="form-input" id="map-display-name" value="Quiet Village">
        </div>
        <div class="form-group">
            <label class="form-label">Width</label>
            <input type="number" class="form-input" id="map-width" min="1" max="100" value="32">
        </div>
        <div class="form-group">
            <label class="form-label">Height</label>
            <input type="number" class="form-input" id="map-height" min="1" max="100" value="20">
        </div>
        <div class="form-group">
            <label class="form-label">Tileset ID</label>
            <input type="text" class="form-input" id="map-tileset-id" value="jrpg">
        </div>
        <div class="form-group">
            <button class="btn btn-primary" id="resize-map">Resize Map</button>
        </div>
    </template>

    <template id="panel-tiles">
        <div class="form-group">
            <label class="form-label">Drawing Mode</label>
            <div class="mode-selector">
                <div class="mode-btn active" data-mode="place">Place</div>
                <div class="mode-btn" data-mode="brush">Brush</div>
                <div class="mode-btn" data-mode="area">Area</div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Selected Tile</label>
            <div id="selected-tile-preview" style="width: 64px; height: 64px; border: 2px solid var(--border-primary); background: var(--bg-tertiary); image-rendering: pixelated;"></div>
        </div>
        <div class="form-group">
            <label class="form-label">Tiles</label>
            <div class="tile-palette" id="tile-palette"></div>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" id="fill-map">Fill Map</button>
        </div>
    </template>

    <template id="panel-events">
        <div class="form-group">
            <label class="form-label">Event List</label>
            <div class="event-list" id="event-list"></div>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" id="add-event">Add Event</button>
            <button class="btn btn-secondary" id="edit-event" disabled>Edit Event</button>
            <button class="btn btn-danger" id="remove-event" disabled>Remove Event</button>
        </div>
    
    </template>

    <template id="panel-export">
        <div class="form-group">
            <label class="form-label">Map Data</label>
            <textarea class="form-textarea" id="export-map-data" readonly></textarea>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" id="copy-map-data">Copy Map Data</button>
            <button class="btn btn-secondary" id="save-project">Save Project</button>
            <button class="btn btn-secondary" id="load-project">Load Project</button>
        </div>
    </template>

    <input type="file" id="project-file-input" accept=".json" style="display: none;">

    <script>
        // Editor state
        let width = 14
        let height = 10
        const state = {
            currentPanel: 'map',
            currentTool: 'place',
            selectedTile: 0,
            zoomLevel: 1,
            mapWidth: width,
            mapHeight: height,
            tileSize: 20,
            displayName: "Quiet Village",
            tilesetId: "jrpg",
            scrollType: 0,
            specifyBattleback: false,
            // Initialize map with all 0s
            mapData: Array(width * height).fill(0),
            events: {},
            selectedEvent: null,
            selectedPosition: { x: 0, y: 0 },
            isDrawing: false,
            areaStart: null,
            areaEnd: null
        };

        // Canvas and context
        const canvas = document.getElementById('tilemap-canvas');
        const ctx = canvas.getContext('2d');

        // Tileset image
        const tileset = new Image();
        tileset.src = 'tileset.png';

        // Wait for tileset to load
        tileset.onload = () => {
            renderMap();
            updateTilePalette();
            updateEventList();
            updateExportData();
        };

        // Activity bar navigation
        document.querySelectorAll('.activity-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.activity-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                state.currentPanel = item.dataset.panel;
                updateSidebar();
            });
        });

        // Mode selector
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-btn')) {
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                state.currentTool = e.target.dataset.mode;
                document.getElementById('editor-mode').textContent = 
                    state.currentTool.charAt(0).toUpperCase() + state.currentTool.slice(1);
            }
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            if (state.zoomLevel < 4) {
                state.zoomLevel *= 2;
                updateZoom();
            }
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            if (state.zoomLevel > 1) {
                state.zoomLevel /= 2;
                updateZoom();
            }
        });

        document.getElementById('zoom-reset').addEventListener('click', () => {
            state.zoomLevel = 1;
            updateZoom();
        });

        // Canvas interaction
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (state.tileSize * state.zoomLevel));
            const y = Math.floor((e.clientY - rect.top) / (state.tileSize * state.zoomLevel));
            
            if (x >= 0 && x < state.mapWidth && y >= 0 && y < state.mapHeight) {
                if (state.currentPanel === 'tiles') {
                    state.isDrawing = true;
                    state.selectedPosition = { x, y };
                    document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                    renderMap(); // Re-render to show selection
                    
                    if (state.currentTool === 'place') {
                        placeTile(x, y);
                    } else if (state.currentTool === 'area') {
                        state.areaStart = { x, y };
                        state.areaEnd = { x, y };
                    }
                } else if (state.currentPanel === 'events') {
                    // Handle event placement/editing
                    state.selectedPosition = { x, y };
                    document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                    // document.getElementById('selected-position-label').textContent = `${x}, ${y}`;
                    renderMap(); // Re-render to show selection
                    
                    const posKey = `${x},${y}`;
                    if (state.events[posKey]) {
                        // Edit existing event
                        state.selectedEvent = state.events[posKey];
                        document.getElementById('edit-event').disabled = false;
                        document.getElementById('remove-event').disabled = false;
                    } else {
                        // Add new event
                        state.selectedEvent = {
                            id: Object.keys(state.events).length + 1,
                            name: `Event ${Object.keys(state.events).length + 1}`,
                            x: x,
                            y: y,
                            pages: [{
                                graphic: { tileId: 0 },
                                list: []
                            }]
                        };
                        document.getElementById('edit-event').disabled = false;
                        document.getElementById('remove-event').disabled = false;
                    }
                    updateEventList();
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (state.tileSize * state.zoomLevel));
            const y = Math.floor((e.clientY - rect.top) / (state.tileSize * state.zoomLevel));
            
            if (x >= 0 && x < state.mapWidth && y >= 0 && y < state.mapHeight) {
                // Update cursor position display only for tiles mode
                if (state.currentPanel === 'tiles') {
                    document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                    
                    if (state.isDrawing) {
                        if (state.currentTool === 'brush') {
                            state.selectedPosition = { x, y };
                            placeTile(x, y);
                        } else if (state.currentTool === 'area') {
                            state.areaEnd = { x, y };
                            renderMap();
                        }
                    } else {
                        // Update selection position for tiles
                        state.selectedPosition = { x, y };
                        renderMap(); // Re-render to show new selection
                    }
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (state.isDrawing && state.currentTool === 'area' && state.areaStart) {
                // Fill the area
                const startX = Math.min(state.areaStart.x, state.areaEnd.x);
                const endX = Math.max(state.areaStart.x, state.areaEnd.x);
                const startY = Math.min(state.areaStart.y, state.areaEnd.y);
                const endY = Math.max(state.areaStart.y, state.areaEnd.y);
                
                for (let y = startY; y <= endY; y++) {
                    for (let x = startX; x <= endX; x++) {
                        const index = y * state.mapWidth + x;
                        state.mapData[index] = state.selectedTile;
                    }
                }
                
                state.areaStart = null;
                state.areaEnd = null;
                renderMap();
                updateExportData();
            }
            
            state.isDrawing = false;
        });

        // Tile placement function
        function placeTile(x, y) {
            const index = y * state.mapWidth + x;
            state.mapData[index] = state.selectedTile;
            renderMap();
            updateExportData();
        }

        // Sidebar buttons
        document.addEventListener('click', (e) => {
            if (e.target.id === 'resize-map') {
                const newWidth = parseInt(document.getElementById('map-width').value);
                const newHeight = parseInt(document.getElementById('map-height').value);
                const newDisplayName = document.getElementById('map-display-name').value;
                const newTilesetId = document.getElementById('map-tileset-id').value;
                
                if (newWidth > 0 && newHeight > 0) {
                    resizeMap(newWidth, newHeight);
                    state.displayName = newDisplayName;
                    state.tilesetId = newTilesetId;
                    updateExportData();
                }
            }
            
            if (e.target.id === 'fill-map') {
                state.mapData = Array(state.mapWidth * state.mapHeight).fill(state.selectedTile);
                renderMap();
                updateExportData();
            }
            
            if (e.target.id === 'add-event') {
                // Add event at selected position
                const posKey = `${state.selectedPosition.x},${state.selectedPosition.y}`;
                if (!state.events[posKey]) {
                    state.events[posKey] = {
                        id: Object.keys(state.events).length + 1,
                        name: `Event ${Object.keys(state.events).length + 1}`,
                        x: state.selectedPosition.x,
                        y: state.selectedPosition.y,
                        pages: [{
                            graphic: { tileId: 0 },
                            list: []
                        }]
                    };
                    updateEventList();
                    updateExportData();
                    renderMap(); // Re-render to show new event
                }
            }
            
            if (e.target.id === 'edit-event') {
                if (state.selectedEvent) {
                    showEventEditorDialog();
                }
            }
            
            if (e.target.id === 'remove-event') {
                const posKey = `${state.selectedPosition.x},${state.selectedPosition.y}`;
                if (state.events[posKey]) {
                    delete state.events[posKey];
                    state.selectedEvent = null;
                    updateEventList();
                    updateExportData();
                    document.getElementById('edit-event').disabled = true;
                    document.getElementById('remove-event').disabled = true;
                    renderMap(); // Re-render to remove event indicator
                }
            }
            
            if (e.target.id === 'copy-map-data') {
                navigator.clipboard.writeText(document.getElementById('export-map-data').value);
            }
            
            if (e.target.id === 'save-project') {
                const projectData = {
                    displayName: state.displayName,
                    tilesetId: state.tilesetId,
                    width: state.mapWidth,
                    height: state.mapHeight,
                    scrollType: state.scrollType,
                    specifyBattleback: state.specifyBattleback,
                    data: state.mapData,
                    events: state.events
                };
                
                const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.displayName || 'project'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            if (e.target.id === 'load-project') {
                document.getElementById('project-file-input').click();
            }
        });

        // Project file input
        document.getElementById('project-file-input') && document.getElementById('project-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const projectData = JSON.parse(event.target.result);
                        
                        // Load project data
                        state.displayName = projectData.displayName || "Untitled";
                        state.tilesetId = projectData.tilesetId || "default";
                        state.mapWidth = projectData.width || 20;
                        state.mapHeight = projectData.height || 15;
                        state.scrollType = projectData.scrollType || 0;
                        state.specifyBattleback = projectData.specifyBattleback || false;
                        state.mapData = projectData.data || Array(state.mapWidth * state.mapHeight).fill(0);
                        state.events = projectData.events || {};
                        
                        // Update UI
                        updateSidebar();
                        updateZoom();
                        renderMap();
                        updateEventList();
                        updateExportData();
                        
                        // Reset file input
                        document.getElementById('project-file-input').value = '';
                    } catch (error) {
                        alert('Error loading project file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Map resizing function
        function resizeMap(newWidth, newHeight) {
            const oldWidth = state.mapWidth;
            const oldHeight = state.mapHeight;
            const oldMapData = [...state.mapData];
            const oldEvents = { ...state.events };
            
            // Update dimensions
            state.mapWidth = newWidth;
            state.mapHeight = newHeight;
            
            // Create new map data
            const newMapData = Array(newWidth * newHeight).fill(1); // Fill with 1s by default
            
            // Copy old data to new map (crop or expand)
            for (let y = 0; y < Math.min(oldHeight, newHeight); y++) {
                for (let x = 0; x < Math.min(oldWidth, newWidth); x++) {
                    const oldIndex = y * oldWidth + x;
                    const newIndex = y * newWidth + x;
                    newMapData[newIndex] = oldMapData[oldIndex];
                }
            }
            
            state.mapData = newMapData;
            
            // Update events (remove events that are now out of bounds)
            state.events = {};
            Object.keys(oldEvents).forEach(posKey => {
                const [x, y] = posKey.split(',').map(Number);
                if (x < newWidth && y < newHeight) {
                    state.events[posKey] = oldEvents[posKey];
                }
            });
            
            // Update canvas size
            updateZoom();
            renderMap();
            updateEventList();
        }

        // Initialize
        updateSidebar();
        updateZoom();

        // Functions
        function updateSidebar() {
            const sidebarContent = document.getElementById('sidebar-content');
            const panelTemplate = document.getElementById(`panel-${state.currentPanel}`);
            
            if (panelTemplate) {
                const panelTitles = {
                    'map': 'Map Settings',
                    'tiles': 'Tiles',
                    'events': 'Events',
                    'export': 'Export'
                };
                
                document.getElementById('sidebar-title').textContent = panelTitles[state.currentPanel];
                sidebarContent.innerHTML = '';
                sidebarContent.appendChild(panelTemplate.content.cloneNode(true));
                
                // Update panel-specific content
                if (state.currentPanel === 'map') {
                    document.getElementById('map-display-name').value = state.displayName;
                    document.getElementById('map-width').value = state.mapWidth;
                    document.getElementById('map-height').value = state.mapHeight;
                    document.getElementById('map-tileset-id').value = state.tilesetId;
                } else if (state.currentPanel === 'tiles') {
                    updateTilePalette();
                    updateSelectedTilePreview();
                    // Set active mode button
                    document.querySelectorAll('.mode-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === state.currentTool);
                    });
                } else if (state.currentPanel === 'events') {
                    document.getElementById('cursor-position').textContent = `${state.selectedPosition.x}, ${state.selectedPosition.y}`;
                    // document.getElementById('selected-position-label').textContent = 
                    //     `${state.selectedPosition.x}, ${state.selectedPosition.y}`;
                    updateEventList();
                } else if (state.currentPanel === 'export') {
                    updateExportData();
                }
            }
        }

        function updateZoom() {
            const newWidth = state.mapWidth * state.tileSize * state.zoomLevel;
            const newHeight = state.mapHeight * state.tileSize * state.zoomLevel;
            canvas.width = newWidth;
            canvas.height = newHeight;
            document.getElementById('zoom-level').textContent = `${state.zoomLevel}x`;
            renderMap();
        }

        function renderMap() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw map tiles
            for (let y = 0; y < state.mapHeight; y++) {
                for (let x = 0; x < state.mapWidth; x++) {
                    const tileId = state.mapData[y * state.mapWidth + x];
                    drawTile(x, y, tileId);
                }
            }
            
            // Draw events
            Object.keys(state.events).forEach(posKey => {
                const [x, y] = posKey.split(',').map(Number);
                const event = state.events[posKey];
                drawEvent(x, y, event.pages[0].graphic.tileId);
            });
            
            // Draw area selection
            if (state.areaStart && state.areaEnd) {
                const startX = Math.min(state.areaStart.x, state.areaEnd.x);
                const endX = Math.max(state.areaStart.x, state.areaEnd.x);
                const startY = Math.min(state.areaStart.y, state.areaEnd.y);
                const endY = Math.max(state.areaStart.y, state.areaEnd.y);
                
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    startX * state.tileSize * state.zoomLevel,
                    startY * state.tileSize * state.zoomLevel,
                    (endX - startX + 1) * state.tileSize * state.zoomLevel,
                    (endY - startY + 1) * state.tileSize * state.zoomLevel
                );
            }
            
            // Highlight selected position
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                state.selectedPosition.x * state.tileSize * state.zoomLevel,
                state.selectedPosition.y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel
            );
        }

        function drawTile(x, y, tileId) {
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (tileId % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(tileId / tilesPerRow) * state.tileSize;
            
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                x * state.tileSize * state.zoomLevel, y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel, state.tileSize * state.zoomLevel
            );
        }

        function drawEvent(x, y, tileId) {
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (tileId % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(tileId / tilesPerRow) * state.tileSize;
            
            // Draw semi-transparent black background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(
                x * state.tileSize * state.zoomLevel,
                y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel
            );
            
            // Draw event graphic
            ctx.save();
            ctx.globalAlpha = 0.8;
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                x * state.tileSize * state.zoomLevel, y * state.tileSize * state.zoomLevel,
                state.tileSize * state.zoomLevel, state.tileSize * state.zoomLevel
            );
            ctx.restore();
        }

        function updateTilePalette() {
            const palette = document.getElementById('tile-palette');
            if (!palette) return;
            
            palette.innerHTML = '';
            
            // Create 160 tiles using background images like graphic-picker
            for (let i = 0; i < 160; i++) {
                const tileItem = document.createElement('div');
                tileItem.className = 'tile-item';
                tileItem.dataset.tileId = i;
                
                // Calculate background position
                const tilesPerRow = Math.floor(tileset.width / state.tileSize);
                const srcX = (i % tilesPerRow) * state.tileSize;
                const srcY = Math.floor(i / tilesPerRow) * state.tileSize;
                
                tileItem.style.backgroundImage = `url('${tileset.src}')`;
                tileItem.style.backgroundPosition = `-${srcX * 2}px -${srcY * 2}px`;
                tileItem.style.backgroundSize = `${tileset.width * 2}px ${tileset.height * 2}px`;
                
                if (i === state.selectedTile) {
                    tileItem.classList.add('selected');
                }
                
                tileItem.addEventListener('click', () => {
                    state.selectedTile = i;
                    document.querySelectorAll('.tile-item').forEach(item => item.classList.remove('selected'));
                    tileItem.classList.add('selected');
                    updateSelectedTilePreview();
                });
                
                palette.appendChild(tileItem);
            }
        }

        function updateSelectedTilePreview() {
            const preview = document.getElementById('selected-tile-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            const tileCanvas = document.createElement('canvas');
            tileCanvas.width = 64;
            tileCanvas.height = 64;
            const tileCtx = tileCanvas.getContext('2d');
            
            const tilesPerRow = Math.floor(tileset.width / state.tileSize);
            const srcX = (state.selectedTile % tilesPerRow) * state.tileSize;
            const srcY = Math.floor(state.selectedTile / tilesPerRow) * state.tileSize;
            
            tileCtx.imageSmoothingEnabled = false;
            tileCtx.drawImage(
                tileset,
                srcX, srcY, state.tileSize, state.tileSize,
                0, 0, 64, 64
            );
            
            preview.appendChild(tileCanvas);
        }

        function updateEventList() {
            const eventList = document.getElementById('event-list');
            if (!eventList) return;
            
            eventList.innerHTML = '';
            
            Object.keys(state.events).forEach(posKey => {
                const [x, y] = posKey.split(',').map(Number);
                const event = state.events[posKey];
                
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                if (x === state.selectedPosition.x && y === state.selectedPosition.y) {
                    eventItem.classList.add('active');
                }
                
                eventItem.innerHTML = `
                    <div><strong>${event.name}</strong></div>
                    <div>Position: ${x}, ${y}</div>
                `;
                
                eventItem.addEventListener('click', () => {
                    state.selectedPosition = { x, y };
                    state.selectedEvent = event;
                    document.getElementById('cursor-position').textContent = `${x}, ${y}`;
                    // document.getElementById('selected-position-label').textContent = `${x}, ${y}`;
                    document.querySelectorAll('.event-item').forEach(item => item.classList.remove('active'));
                    eventItem.classList.add('active');
                    document.getElementById('edit-event').disabled = false;
                    document.getElementById('remove-event').disabled = false;
                    renderMap(); // Re-render to show selection
                });
                
                eventList.appendChild(eventItem);
            });
        }

        function showEventEditorDialog() {
            // Create dialog overlay
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            
            // Create dialog
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            
            // Dialog header
            const header = document.createElement('div');
            header.className = 'dialog-header';
            header.innerHTML = `
                <h3>Edit Event</h3>
                <button class="btn btn-secondary" id="close-dialog">✕</button>
            `;
            
            // Dialog content
            const content = document.createElement('div');
            content.className = 'dialog-content';
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" class="form-input" id="event-name" value="${state.selectedEvent.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Page</label>
                    <select class="form-select" id="page-selector">
                        ${state.selectedEvent.pages.map((page, index) => 
                            `<option value="${index}">Page ${index + 1}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="page-editor" id="page-editor">
                    <!-- Page editor content will be inserted here -->
                </div>
            `;
            
            // Dialog footer
            const footer = document.createElement('div');
            footer.className = 'dialog-footer';
            footer.innerHTML = `
                <button class="btn btn-secondary" id="add-page">Add Page</button>
                <button class="btn btn-danger" id="delete-page">Delete Page</button>
                <button class="btn btn-primary" id="save-event-dialog">Save</button>
            `;
            
            dialog.appendChild(header);
            dialog.appendChild(content);
            dialog.appendChild(footer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Initialize page editor
            updatePageEditor(0);
            
            // Event listeners
            document.getElementById('close-dialog').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            document.getElementById('page-selector').addEventListener('change', (e) => {
                updatePageEditor(parseInt(e.target.value));
            });
            
            document.getElementById('add-page').addEventListener('click', () => {
                state.selectedEvent.pages.push({
                    graphic: { tileId: 0 },
                    list: []
                });
                const selector = document.getElementById('page-selector');
                const newIndex = state.selectedEvent.pages.length - 1;
                const option = document.createElement('option');
                option.value = newIndex;
                option.textContent = `Page ${newIndex + 1}`;
                selector.appendChild(option);
                selector.value = newIndex;
                updatePageEditor(newIndex);
            });
            
            document.getElementById('delete-page').addEventListener('click', () => {
                const selector = document.getElementById('page-selector');
                const index = parseInt(selector.value);
                if (state.selectedEvent.pages.length > 1) {
                    state.selectedEvent.pages.splice(index, 1);
                    selector.innerHTML = state.selectedEvent.pages.map((page, i) => 
                        `<option value="${i}">Page ${i + 1}</option>`
                    ).join('');
                    selector.value = Math.max(0, index - 1);
                    updatePageEditor(parseInt(selector.value));
                }
            });
            
            document.getElementById('save-event-dialog').addEventListener('click', () => {
                // Save current page
                saveCurrentPage();
                
                // Update event data
                state.selectedEvent.name = document.getElementById('event-name').value;
                
                // Save to events object
                const posKey = `${state.selectedEvent.x},${state.selectedEvent.y}`;
                state.events[posKey] = state.selectedEvent;
                
                // Update UI
                updateEventList();
                updateExportData();
                renderMap();
                
                // Close dialog
                document.body.removeChild(overlay);
            });
        }

        function updatePageEditor(pageIndex) {
            const page = state.selectedEvent.pages[pageIndex];
            const editor = document.getElementById('page-editor');
            
            editor.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Graphic</label>
                    <div class="graphic-picker" id="graphic-picker">
                        <!-- Graphic tiles will be inserted here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Commands</label>
                    <div class="command-list" id="command-list">
                        <!-- Commands will be inserted here -->
                    </div>
                    <div class="add-command" id="add-command">+ Add Command</div>
                </div>
            `;
            
            // Populate graphic picker
            const graphicPicker = document.getElementById('graphic-picker');
            for (let i = 0; i < 160; i++) {
                const graphicItem = document.createElement('div');
                graphicItem.className = 'graphic-item';
                graphicItem.dataset.tileId = i;
                
                // Calculate background position
                const tilesPerRow = Math.floor(tileset.width / state.tileSize);
                const srcX = (i % tilesPerRow) * state.tileSize;
                const srcY = Math.floor(i / tilesPerRow) * state.tileSize;
                
                graphicItem.style.backgroundImage = `url('${tileset.src}')`;
                graphicItem.style.backgroundPosition = `-${srcX * 2}px -${srcY * 2}px`;
                graphicItem.style.backgroundSize = `${tileset.width * 2}px ${tileset.height * 2}px`;
                
                if (i === page.graphic.tileId) {
                    graphicItem.classList.add('selected');
                }
                
                graphicItem.addEventListener('click', () => {
                    document.querySelectorAll('.graphic-item').forEach(item => item.classList.remove('selected'));
                    graphicItem.classList.add('selected');
                    page.graphic.tileId = i;
                });
                
                graphicPicker.appendChild(graphicItem);
            }
            
            // Populate command list
            updateCommandList(pageIndex);
            
            // Add command button
            document.getElementById('add-command').addEventListener('click', () => {
                showAddCommandDialog(pageIndex);
            });
        }

        function updateCommandList(pageIndex) {
            const page = state.selectedEvent.pages[pageIndex];
            const commandList = document.getElementById('command-list');
            
            commandList.innerHTML = '';
            
            page.list.forEach((command, index) => {
                const commandItem = document.createElement('div');
                commandItem.className = 'command-item';
                commandItem.dataset.index = index;
                
                if (command.code === 101) {
                    commandItem.textContent = 'Show Text';
                } else if (command.code === 401) {
                    commandItem.textContent = `Text: ${command.parameters[0]}`;
                } else if (command.code === 201) {
                    commandItem.textContent = `Transfer Player: Map ${command.parameters[1]}, (${command.parameters[2]}, ${command.parameters[3]})`;
                } else if (command.code === 122) {
                    commandItem.textContent = `Control Variables: Set Variable #${command.parameters[0]} to ${command.parameters[4]}`;
                } else {
                    commandItem.textContent = `Command ${command.code}`;
                }
                
                commandItem.addEventListener('click', () => {
                    showEditCommandDialog(pageIndex, index);
                });
                
                commandList.appendChild(commandItem);
            });
        }

        function showAddCommandDialog(pageIndex) {
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.style.width = '400px';
            
            const header = document.createElement('div');
            header.className = 'dialog-header';
            header.innerHTML = `
                <h3>Add Command</h3>
                <button class="btn btn-secondary" id="close-add-command">✕</button>
            `;
            
            const content = document.createElement('div');
            content.className = 'dialog-content';
            content.innerHTML = `
                <div class="form-group">
                    <button class="btn btn-primary" id="add-show-text">Show Text</button>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="add-transfer-player">Transfer Player</button>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="add-control-variables">Control Variables</button>
                </div>
            `;
            
            dialog.appendChild(header);
            dialog.appendChild(content);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            document.getElementById('close-add-command').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            document.getElementById('add-show-text').addEventListener('click', () => {
                const page = state.selectedEvent.pages[pageIndex];
                page.list.push({ code: 101, parameters: [] });
                page.list.push({ code: 401, parameters: [""] });
                updateCommandList(pageIndex);
                document.body.removeChild(overlay);
            });
            
            document.getElementById('add-transfer-player').addEventListener('click', () => {
                const page = state.selectedEvent.pages[pageIndex];
                page.list.push({ code: 201, parameters: [0, 1, 0, 0] });
                updateCommandList(pageIndex);
                document.body.removeChild(overlay);
            });
            
            document.getElementById('add-control-variables').addEventListener('click', () => {
                const page = state.selectedEvent.pages[pageIndex];
                page.list.push({ code: 122, parameters: [1, 1, 0, 0, 0] });
                updateCommandList(pageIndex);
                document.body.removeChild(overlay);
            });
        }

        function showEditCommandDialog(pageIndex, commandIndex) {
            const page = state.selectedEvent.pages[pageIndex];
            const command = page.list[commandIndex];
            
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            
            const header = document.createElement('div');
            header.className = 'dialog-header';
            header.innerHTML = `
                <h3>Edit Command</h3>
                <button class="btn btn-secondary" id="close-edit-command">✕</button>
            `;
            
            let contentHTML = '';
            
            if (command.code === 101) {
                contentHTML = `
                    <div class="form-group">
                        <label class="form-label">Show Text Command</label>
                        <p>This is a text display command.</p>
                    </div>
                `;
            } else if (command.code === 401) {
                contentHTML = `
                    <div class="form-group">
                        <label class="form-label">Text Line</label>
                        <input type="text" class="form-input" id="text-line" value="${command.parameters[0]}">
                    </div>
                `;
            } else if (command.code === 201) {
                contentHTML = `
                    <div class="form-group">
                        <label class="form-label">Map ID</label>
                        <input type="number" class="form-input" id="map-id" value="${command.parameters[1]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">X Position</label>
                        <input type="number" class="form-input" id="x-pos" value="${command.parameters[2]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Y Position</label>
                        <input type="number" class="form-input" id="y-pos" value="${command.parameters[3]}">
                    </div>
                `;
            } else if (command.code === 122) {
                contentHTML = `
                    <div class="form-group">
                        <label class="form-label">Variable ID (Start)</label>
                        <input type="number" class="form-input" id="var-start" value="${command.parameters[0]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Variable ID (End)</label>
                        <input type="number" class="form-input" id="var-end" value="${command.parameters[1]}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operation</label>
                        <select class="form-select" id="operation">
                            <option value="0" ${command.parameters[2] === 0 ? 'selected' : ''}>Set</option>
                            <option value="1" ${command.parameters[2] === 1 ? 'selected' : ''}>Add</option>
                            <option value="2" ${command.parameters[2] === 2 ? 'selected' : ''}>Sub</option>
                            <option value="3" ${command.parameters[2] === 3 ? 'selected' : ''}>Mult</option>
                            <option value="4" ${command.parameters[2] === 4 ? 'selected' : ''}>Div</option>
                            <option value="5" ${command.parameters[2] === 5 ? 'selected' : ''}>Mod</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operand Type</label>
                        <select class="form-select" id="operand-type">
                            <option value="0" ${command.parameters[3] === 0 ? 'selected' : ''}>Constant</option>
                            <option value="1" ${command.parameters[3] === 1 ? 'selected' : ''}>Variable</option>
                            <option value="2" ${command.parameters[3] === 2 ? 'selected' : ''}>Random</option>
                            <option value="3" ${command.parameters[3] === 3 ? 'selected' : ''}>Game Data</option>
                            <option value="4" ${command.parameters[3] === 4 ? 'selected' : ''}>Script</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Value</label>
                        <input type="number" class="form-input" id="operand-value" value="${command.parameters[4]}">
                    </div>
                `;
            }
            
            const content = document.createElement('div');
            content.className = 'dialog-content';
            content.innerHTML = contentHTML;
            
            const footer = document.createElement('div');
            footer.className = 'dialog-footer';
            footer.innerHTML = `
                <button class="btn btn-danger" id="delete-command">Delete</button>
                <button class="btn btn-primary" id="save-command">Save</button>
            `;
            
            dialog.appendChild(header);
            dialog.appendChild(content);
            dialog.appendChild(footer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            document.getElementById('close-edit-command').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            document.getElementById('delete-command').addEventListener('click', () => {
                // For text commands, we need to remove both the 101 and 401 commands
                if (command.code === 101) {
                    // Remove the 101 and the next 401
                    page.list.splice(commandIndex, 2);
                } else if (command.code === 401) {
                    // Remove the 401 and the previous 101
                    page.list.splice(commandIndex - 1, 2);
                } else {
                    // Remove just this command
                    page.list.splice(commandIndex, 1);
                }
                updateCommandList(pageIndex);
                document.body.removeChild(overlay);
            });
            
            document.getElementById('save-command').addEventListener('click', () => {
                if (command.code === 401) {
                    command.parameters[0] = document.getElementById('text-line').value;
                } else if (command.code === 201) {
                    command.parameters[1] = parseInt(document.getElementById('map-id').value);
                    command.parameters[2] = parseInt(document.getElementById('x-pos').value);
                    command.parameters[3] = parseInt(document.getElementById('y-pos').value);
                } else if (command.code === 122) {
                    command.parameters[0] = parseInt(document.getElementById('var-start').value);
                    command.parameters[1] = parseInt(document.getElementById('var-end').value);
                    command.parameters[2] = parseInt(document.getElementById('operation').value);
                    command.parameters[3] = parseInt(document.getElementById('operand-type').value);
                    command.parameters[4] = parseInt(document.getElementById('operand-value').value);
                }
                updateCommandList(pageIndex);
                document.body.removeChild(overlay);
            });
        }

        function saveCurrentPage() {
            const pageIndex = parseInt(document.getElementById('page-selector').value);
            const page = state.selectedEvent.pages[pageIndex];
            
            // Save graphic
            const selectedGraphic = document.querySelector('.graphic-item.selected');
            if (selectedGraphic) {
                page.graphic.tileId = parseInt(selectedGraphic.dataset.tileId);
            }
        }

        function updateExportData() {
            const exportElement = document.getElementById('export-map-data');
            if (!exportElement) return;
            
            let exportStr = 'HEADER = {\n';
            exportStr += '    \'description\': \'Map Data\',\n';
            exportStr += '    \'exports\': ["displayName", "tilesetId", "width", "height", "scrollType", "specifyBattleback", "data", "events"],\n';
            exportStr += '}\n\n';
            
            exportStr += `displayName = "${state.displayName}"\n`;
            exportStr += `tilesetId = "${state.tilesetId}" # Corresponds to the key in AssetManager\n`;
            exportStr += `width = ${state.mapWidth}\n`;
            exportStr += `height = ${state.mapHeight}\n`;
            exportStr += `scrollType = ${state.scrollType}\n`;
            exportStr += `specifyBattleback = ${state.specifyBattleback}\n\n`;
            
            exportStr += 'data = [\n';
            for (let y = 0; y < state.mapHeight; y++) {
                let rowStr = '    ';
                for (let x = 0; x < state.mapWidth; x++) {
                    const index = y * state.mapWidth + x;
                    rowStr += state.mapData[index];
                    if (x < state.mapWidth - 1) {
                        rowStr += ', ';
                    }
                }
                if (y < state.mapHeight - 1) {
                    rowStr += ',';
                }
                exportStr += rowStr + '\n';
            }
            exportStr += ']\n\n';
            
            exportStr += 'events = {\n';
            const eventKeys = Object.keys(state.events);
            eventKeys.forEach((posKey, index) => {
                const [x, y] = posKey.split(',').map(Number);
                const event = state.events[posKey];
                exportStr += `    # Event at (x=${x}, y=${y})\n`;
                exportStr += `    (${x}, ${y}): { # Event ID ${event.id}\n`;
                exportStr += `        "id": ${event.id},\n`;
                exportStr += `        "name": "${event.name}",\n`;
                exportStr += `        "x": ${event.x}, "y": ${event.y},\n`;
                exportStr += `        "pages": [${JSON.stringify(event.pages[0])}]\n`;
                exportStr += '    }';
                if (index < eventKeys.length - 1) {
                    exportStr += ',\n';
                }
                exportStr += '\n';
            });
            exportStr += '}';
            
            exportElement.value = exportStr;
        }
    </script>
</body>
</html>